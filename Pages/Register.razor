@page "/registrar-dueno"
@using Veterinaria.Data
@using Veterinaria.Service
@inject NavigationManager Navigation
@inject RenaperService RenaperService
@inject OwnerService OwnerService

<div class="form-container">
    <header class="form-header">
        <h1>Registrar Dueño</h1>
        <p>Ingrese el CUIL para buscar o complete los datos manualmente</p>
    </header>

    <EditForm Model="@owner" OnValidSubmit="Submit" class="form">
        <DataAnnotationsValidator />

        <div class="form-row">
            <div class="form-group">
                <label for="cuil">CUIL (11 dígitos) *</label>
                <input type="text"
                       id="cuil"
                       class="form-control"
                       value="@owner.Cuil"
                       @oninput="OnCuilChanged"
                       placeholder="Ej: 20123456789"
                       maxlength="11" />
                <ValidationMessage For="@(() => owner.Cuil)" />

                @if (buscando)
                {
                    <span class="text-info" style="font-size: 0.9em; font-weight: bold;">Buscando en API...</span>
                }
            </div>

            <div class="form-group">
                <label for="dni">DNI *</label>
                <InputText id="dni"
                           @bind-Value="owner.Dni"
                           class="form-control"
                           placeholder="Ingrese DNI manualmente"
                           disabled="@datosBloqueados" />
                <ValidationMessage For="@(() => owner.Dni)" />
            </div>
        </div>

        <div class="form-group">
            <label for="nombre">Nombre Completo *</label>
            <InputText id="nombre"
                       @bind-Value="owner.NombreCompleto"
                       class="form-control"
                       placeholder="Ingrese nombre completo"
                       disabled="@datosBloqueados" />
            <ValidationMessage For="@(() => owner.NombreCompleto)" />
        </div>

        <div class="form-group">
            <label for="domicilio">Domicilio *</label>
            <InputText id="domicilio"
                       @bind-Value="owner.Domicilio"
                       class="form-control"
                       placeholder="Calle, número, ciudad"
                       disabled="@datosBloqueados" />
            <ValidationMessage For="@(() => owner.Domicilio)" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="email">Email *</label>
                <InputText id="email"
                           @bind-Value="owner.Email"
                           class="form-control"
                           placeholder="ejemplo@correo.com" />
                <ValidationMessage For="@(() => owner.Email)" />
            </div>

            <div class="form-group">
                <label for="telefono">Teléfono *</label>
                <InputText id="telefono"
                           @bind-Value="owner.Telefono"
                           class="form-control"
                           placeholder="Ej: 11 1234 5678" />
                <ValidationMessage For="@(() => owner.Telefono)" />
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                Cancelar
            </button>
            <button type="submit" class="btn btn-primary" disabled="@guardando">
                @(guardando ? "Guardando..." : "Guardar Dueño")
            </button>
        </div>

        @if (errorApi != null)
        {
            <p class="text-warning">@errorApi</p>
        }
        @if (saveMessage != null)
        {
            <p class="text-success">@saveMessage</p>
        }
        @if (errorMessage != null)
        {
            <p class="text-danger">@errorMessage</p>
        }

    </EditForm>
</div>

<style>
    .form-control:disabled {
        background-color: #e9ecef;
        opacity: 1;
        cursor: not-allowed;
    }
    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-secondary {
        color: #424242;
        background: #f5f5f5;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px 24px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-secondary:hover {
            background: #e0e0e0;
            border-color: #bdbdbd;
        }

    .form-group {
        margin-bottom: 20px;
    }

    .text-success {
        color: #2e7d32;
        font-weight: 500;
        margin-top: 15px;
        text-align: center;
        background-color: #d4edda;
        padding: 10px;
        border-radius: 5px;
    }

    .text-danger {
        color: #d32f2f;
        font-weight: 500;
        margin-top: 15px;
        text-align: center;
        background-color: #f8d7da;
        padding: 10px;
        border-radius: 5px;
    }

    .text-warning {
        color: #856404;
        background-color: #fff3cd;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        margin-top: 10px;
    }

    .text-info {
        color: #0c5460;
    }
</style>

@code {
    private Owner owner = new Owner();
    private bool buscando = false;
    private bool guardando = false;
    private bool datosBloqueados = false; 

    private string? errorApi = null;
    private string? saveMessage = null;
    private string? errorMessage = null;


    private async Task OnCuilChanged(ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? "";
        if (!long.TryParse(input, out _) && input != "") return;

        owner.Cuil = input;
        errorApi = null;

        if (owner.Cuil.Length != 11)
        {
            datosBloqueados = false;
            if (owner.IdOwner != 0) owner = new Owner { Cuil = input };
        }

        if (owner.Cuil.Length == 11)
        {
            await BuscarDatos(owner.Cuil);
        }
    }

    
    private async Task BuscarDatos(string cuil)
    {
        buscando = true;
        saveMessage = null;
        errorMessage = null;
        StateHasChanged();

        var ownerExistente = await OwnerService.GetOwnerByCuil(cuil);

        var personaApi = await RenaperService.GetPersonaByCuil(cuil);

        if (ownerExistente != null)
        {
            owner = ownerExistente;

            saveMessage = "El dueño ya existe. Puede actualizar sus datos de contacto.";
            datosBloqueados = true;
        }
        else if (personaApi != null)
        {
            owner = new Owner { Cuil = cuil };

            owner.NombreCompleto = $"{personaApi.Nombres} {personaApi.Apellido}".Trim();
            owner.Domicilio = personaApi.Direccion ?? "";
            owner.Dni = !string.IsNullOrEmpty(personaApi.Dni) ? personaApi.Dni : ExtraerDniDeCuil(cuil);

            
            owner.Email = personaApi.Mail ?? "";
            owner.Telefono = personaApi.Telefono ?? "";

            datosBloqueados = true;
            errorApi = null;
        }
        else
        {
            
            datosBloqueados = false;
            errorApi = "No se encontró información. Ingrese los datos manualmente.";
            
            if (owner.IdOwner != 0) owner = new Owner { Cuil = cuil };
        }

        buscando = false;
        StateHasChanged();
    }

    private string ExtraerDniDeCuil(string cuil)
    {
        if (cuil.Length == 11) return cuil.Substring(2, 8);
        return "";
    }

    private async Task Submit()
    {
        guardando = true;
        saveMessage = null;
        errorMessage = null;

        
        bool exito = await OwnerService.SaveOwner(owner);

        if (exito)
        {
            saveMessage = owner.IdOwner > 0
                ? "¡Datos del dueño actualizados con éxito!"
                : "¡Dueño registrado con éxito!";

            StateHasChanged();
            await Task.Delay(3000);
            Navigation.NavigateTo("/");
        }
        else
        {
            errorMessage = "Error al guardar en la base de datos.";
            guardando = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}